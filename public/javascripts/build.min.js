!function(){function a(a,b){var c,d,e=USERNAME,f=new Date,g=f.getHours(),h=f.getMinutes(),i=f.getSeconds(),j=g>9?g.toString():"0"+g.toString(),k=h>9?h.toString():"0"+h.toString(),n=i>9?i.toString():"0"+i.toString();return c={type:m,content:b},d=g>=12?j+":"+k+":"+n+"  PM":j+":"+k+":"+n+"  AM",packageMessage("broadcast",l,o,p,{username:e,time:d,content:c})}function b(){$("#chat-dynamic").empty()}function c(){q.emit("message",packageMessage("list",l,o,p,"null"))}function d(){q.emit("message",a(m,$("#message-box input").val())),$("#message-box input").val("")}function e(a){switch(a.content.type){case n:void 0===$("#file-"+a.content.hashCode+"-bar>.progress-bar").css("width")&&g(a),f(a);break;case m:h(a)}}function f(a){function b(a){$("#file-"+a.content.hashCode+"-box>p").html($("#file-"+a.content.hashCode+"-box>p").html().split(a.content.filename).join("图:")),$("#file-"+a.content.hashCode+"-box>p>a").attr("href",a.address),$("#file-"+a.content.hashCode+"-box>p>a>img").attr("src",a.content.filename).addClass("receiveImage"),$("#file-"+a.content.hashCode+"-box>p").css("background-color","#9DFFB0")}function c(a){d(a)}function d(a){$("#file-"+a.content.hashCode+"-box>p>a").attr("href",a.address),$("#file-"+a.content.hashCode+"-box>p>a>img").attr("src","img/filedone.png"),$("#file-"+a.content.hashCode+"-box>p").css("background-color","#9DFFB0")}void 0===a.address?($("#file-"+a.content.hashCode+"-bar>.progress-bar").css("width",a.content.percentage+"%"),$("#file-"+a.content.hashCode+"-bar>.progress-bar").text(a.content.percentage+"%")):($("#file-"+a.content.hashCode+"-bar>.progress-bar").css("width","100%"),$("#file-"+a.content.hashCode+"-bar>.progress-bar").text("100%"),setTimeout(function(){switch(console.log(a.content.fileType),a.content.fileType){case"img":b(a);break;case"video":c(a);break;case"normal":d(a)}$("#file-"+a.content.hashCode+"-bar").remove()},1e3))}function g(a){var b='<div class="fileBox" id="file-'+a.content.hashCode+'-box"><p><b>('+a.time+") "+a.username+" : "+a.content.filename+'</b><a target="_blank"><img src = "img/loading.gif"></img></a></p><div id="file-'+a.content.hashCode+'-bar" class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</div></div></div>';$("#chat-dynamic").append(b),$("#file-"+a.content.hashCode+"-bar").css("width",$("#file-"+a.content.hashCode+"-box>p").css("width"));var c=$("#chat-dynamic").height()+2*$("#chat-box-header").height()-$("#chat-box").height();$("#chat-box").scrollTop(c)}function h(a){$("#chat-dynamic").append("<p><b>("+a.time+") "+a.username+" : "+a.content.content+"</b></p>");var b=$("#chat-dynamic").height()+2*$("#chat-box-header").height()-$("#chat-box").height();$("#chat-box").scrollTop(b)}function i(a){var b,c=a.userlist;if(void 0!==c){for(var d="",e=0;e<c.length;e++)b="<button id='dropdownBtn' type='button' class='dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><span class='caret'></span></button><ul role='menu' class='dropdown-menu' aria-labelledby='dropdownBtn'><li role='presentaion' class='p2pChat'><a username="+c[e].username+">和他单独聊天</a></li></ul>",d=d+"<tr><td class='dropdown' width='100px'><span>"+c[e].username+"</span>"+b+"</td></tr>";$("#chat-list").html(d),$(".p2pChat a").each(function(){$(this).click(function(){var a=window.confirm("跳转到私聊房间？");if(a===!0){var b=decodeURIComponent(window.location.toString().split("?username=")).split(",")[1],c=$(this).attr("username"),d=b+"~"+c;q.emit("message",packageMessage("p2pChatReq",l,o,p,{roomID:d,p2pFromUsername:b,p2pToUsername:c}));var e="/p2pChat?username="+b+"&&roomID="+d;window.open(e,"_blank")}})})}}function j(a){var b=decodeURIComponent(window.location.toString().split("?username=")).split(",")[1],c=a.data.roomID;if(a.data.p2pToUser.username==b){alert(a.data.p2pFromUser.username+"想和你私聊，即将跳转到私聊房间");var d="/p2pChat?username="+b+"&&roomID="+c;window.open(d,"_blank")}}var k,l,m="TEXT",n="FILE",o={ip:"127.0.0.1",portaddr:"3000"},p="cookie null",q=io();q.on("welcome",function(a){k=a,l={ip:k,portaddr:"8888"},$(document).ready(function(){setUser(),c()})}),q.on("response",function(a){switch(a.statusCode){case 400:i(a.data);break;case 404:handleChatListError();break;case 500:e(a.data);break;case 600:j(a)}}),$("#message-box input").keydown(function(a){13===a.keyCode&&$("#send-message").click()}),$("#send-message").click(function(){d()}),$("body").keydown(function(a){27===a.keyCode&&$("#clean-box").click()}),$("#clean-box").on("click",b)}(),function(){function a(a,b,c){var f,h,k=USERNAME,l=new Date,m=l.getHours(),n=l.getMinutes(),o=l.getSeconds(),p=m>9?m.toString():"0"+m.toString(),q=n>9?n.toString():"0"+n.toString(),r=o>9?o.toString():"0"+o.toString();return f={type:e,filename:c,filesize:g.size,content:b},h=m>12?p+":"+q+":"+r+"  PM":p+":"+q+":"+r+"  AM",packageMessage("broadcast",d,i,j,{username:k,time:h,content:f})}function b(){function b(a){j&&0!==a.size&&(k.readAsBinaryString(a),j=!1)}function c(a,b,c){try{if(c.slice)return c.slice(a,a+Math.min(b-a,f))}catch(d){console.log(d),alert("你的浏览器不支持上传")}}var d=0,i=g.file.size,j=!0;b(c(d,i,g.file)),$("#file-upload").val(""),k.onprogress=function(){},k.onerror=function(){console.log("something wrong, CODE: "+k.error.code)},k.onload=function(){return h.emit("message",a(e,{data:k.result,Final:d+f>=i?!0:!1},g.name)),j=!0,d+=f,d+f>=i&&(l=!0),console.log(l),function(){b(c(d,i,g.file))}()}}var c,d,e="FILE",f=5242880,g={name:"",file:"",size:0},h=io(),i={ip:"127.0.0.1",portaddr:"3000"},j="cookie null",k=new FileReader,l=!0;h.on("welcome",function(a){c=a,d={ip:c,portaddr:"8888"}}),$("#send-file").click(function(){console.log($("#file-upload").file),""!==$("#file-upload").val()?l?(l=!1,g.name=$("#file-upload")[0].files[0].name,g.file=$("#file-upload")[0].files[0],g.size=g.file.size,b()):alert("文件 "+g.name+" 正在传输，请稍等."):alert("请先选择文件")})}(),function(){var a=io(),b="",c="",d="null cookie",e="";a.on("welcome",function(f){b={ip:f,portaddr:"8888"},c={ip:"127.0.0.1",portaddr:"3000"},$("#login-form").keydown(function(a){13===a.keyCode&&$("#btn-login").click()}),$("#btn-login").on("click",function(){var f=$("#login-user input").val(),g=$("#login-password input").val();e={username:f,password:g};var h=packageMessage("login",b,c,d,e);a.emit("message",h)}),a.on("response",function(a){204==a.statusCode&&(alert(a.data),$("#login-password input").val("")),200==a.statusCode&&(alert("欢迎回来 "+a.data+" !"),USERNAME=a.data,window.location="/chat?username="+USERNAME)})})}(),function(){var a=io(),b="",c="",d="null cookie",e="";a.on("welcome",function(f){b={ip:f,portaddr:"8888"},c={ip:"127.0.0.1",portaddr:"3000"},$("#logout").on("click",function(){$("#login-user input").val(),$("#login-password input").val();e=getUser();var f=packageMessage("logout",b,c,d,e);a.emit("message",f)}),a.on("response",function(a){304==a.statusCode&&alert(a.data),300==a.statusCode&&(alert("退出成功，欢迎下次再来！"),window.location="/")})})}(),function(){function a(a,b){var c,d,e=decodeURIComponent(window.location.toString().split("?username=")[1].split("&&")[0]),f=new Date,g=f.getHours(),h=f.getMinutes(),l=f.getSeconds(),n=g>9?g.toString():"0"+g.toString(),o=h>9?h.toString():"0"+h.toString(),p=l>9?l.toString():"0"+l.toString();return c={type:k,content:b},d=g>12?n+":"+o+":"+p+"  PM":n+":"+o+":"+p+"  AM",packageMessage("p2pChat",i,j,m,{username:e,time:d,content:c})}function b(){$("#p2pChat-dynamic").empty()}function c(){n.emit("p2pMessage",a(k,$("#p2pMessage-box input").val())),$("#p2pMessage-box input").val("")}function d(a){switch(a.content.type){case l:void 0===$("#file-"+a.content.hashCode+"-bar>.progress-bar").css("width")&&f(a),e(a);break;case k:g(a)}}function e(a){function b(a){$("#file-"+a.content.hashCode+"-box>p").html($("#file-"+a.content.hashCode+"-box>p").html().split(a.content.filename).join("图:")),$("#file-"+a.content.hashCode+"-box>p>a").attr("href",a.address),$("#file-"+a.content.hashCode+"-box>p>a>img").attr("src",a.content.filename).addClass("receiveImage"),$("#file-"+a.content.hashCode+"-box>p").css("background-color","#9DFFB0")}function c(a){d(a)}function d(a){$("#file-"+a.content.hashCode+"-box>p>a").attr("href",a.address),$("#file-"+a.content.hashCode+"-box>p>a>img").attr("src","img/filedone.png"),$("#file-"+a.content.hashCode+"-box>p").css("background-color","#9DFFB0")}void 0===a.address?($("#file-"+a.content.hashCode+"-bar>.progress-bar").css("width",a.content.percentage+"%"),$("#file-"+a.content.hashCode+"-bar>.progress-bar").text(a.content.percentage+"%")):($("#file-"+a.content.hashCode+"-bar>.progress-bar").css("width","100%"),$("#file-"+a.content.hashCode+"-bar>.progress-bar").text("100%"),setTimeout(function(){switch(console.log(a.content.fileType),a.content.fileType){case"img":b(a);break;case"video":c(a);break;case"normal":d(a)}$("#file-"+a.content.hashCode+"-bar").remove()},1e3))}function f(a){var b='<div class="fileBox" id="file-'+a.content.hashCode+'-box"><p><b>('+a.time+") "+a.username+" : "+a.content.filename+'</b><a target="_blank"><img src = "img/loading.gif"></img></a></p><div id="file-'+a.content.hashCode+'-bar" class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</div></div></div>';$("#p2pChat-dynamic").append(b),$("#file-"+a.content.hashCode+"-bar").css("width",$("#file-"+a.content.hashCode+"-box>p").css("width"));var c=$("#p2pChat-dynamic").height()+2*$("#p2pChat-box-header").height()-$("#p2pChat-box").height();$("#p2pChat-box").scrollTop(c)}function g(a){$("#p2pChat-dynamic").append("<p><b>("+a.time+") "+a.username+" : "+a.content.content+"</b></p>");var b=$("#p2pChat-dynamic").height()+2*$("#p2pChat-box-header").height()-$("#p2pChat-box").height();$("#p2pChat-box").scrollTop(b)}function h(a){var b,c=decodeURIComponent(location.toString().split("?username=")[1].split("&&")).split(",")[0];c==a.p2pFromUser.username?(b=a.p2pToUser.username,i={ip:a.p2pFromUser.ip,portaddr:a.p2pFromUser.port},j={ip:a.p2pToUser.ip,portaddr:a.p2pToUser.port}):(b=a.p2pFromUser.username,i={ip:a.p2pToUser.ip,portaddr:a.p2pToUser.port},j={ip:a.p2pFromUser.ip,portaddr:a.p2pFromUser.port});var d="<tr><td width='100px'><span>"+b+"</span></td></tr>";$("#p2p-list").html(d)}var i,j,k="TEXT",l="FILE",m="cookie null",n=io();n.on("p2pWelcome",function(a){h(a)}),n.on("p2pMessage",function(a){d(a.data)}),n.on("p2pDisconnect",function(a){$("#p2p-list").html(""),alert(a.message)}),$("#p2pMessage-box input").keydown(function(a){13===a.keyCode&&$("#p2p-send-message").click()}),$("#p2p-send-message").click(function(){c()}),$("#go-back").click(function(){alert("即将退出私聊房间")}),$("body").keydown(function(a){27===a.keyCode&&$("#p2p-clean-box").click()}),$("#p2p-clean-box").on("click",b)}(),function(){function a(a,b,c){var f,h,k=window.location.toString().split("?username=")[1].split("&&")[0],l=new Date,m=l.getHours(),n=l.getMinutes(),o=l.getSeconds(),p=m>9?m.toString():"0"+m.toString(),q=n>9?n.toString():"0"+n.toString(),r=o>9?o.toString():"0"+o.toString();return f={type:e,filename:c,filesize:g.size,content:b},h=m>12?p+":"+q+":"+r+"  PM":p+":"+q+":"+r+"  AM",packageMessage("p2pChat",d,i,j,{username:k,time:h,content:f})}function b(){function b(a){j&&0!==a.size&&(k.readAsBinaryString(a),j=!1)}function c(a,b,c){try{if(c.slice)return c.slice(a,a+Math.min(b-a,f))}catch(d){console.log(d),alert("你的浏览器不支持上传")}}var d=0,i=g.file.size,j=!0;b(c(d,i,g.file)),$("#p2p-file-upload").val(""),k.onprogress=function(){},k.onerror=function(){console.log("something wrong, CODE: "+k.error.code)},k.onload=function(){return h.emit("p2pMessage",a(e,{data:k.result,Final:d+f>=i?!0:!1},g.name)),j=!0,d+=f,d+f>=i&&(l=!0),console.log(l),function(){b(c(d,i,g.file))}()}}var c,d,e="FILE",f=5242880,g={name:"",file:"",size:0},h=io(),i={ip:"127.0.0.1",portaddr:"3000"},j="cookie null",k=new FileReader,l=!0;h.on("welcome",function(a){c=a,d={ip:c,portaddr:"8888"}}),$("#p2p-send-file").click(function(){console.log($("#p2p-file-upload").file),""!==$("#p2p-file-upload").val()?l?(l=!1,g.name=$("#p2p-file-upload")[0].files[0].name,g.file=$("#p2p-file-upload")[0].files[0],g.size=g.file.size,b()):alert("文件 "+g.name+" 正在传输，请稍等."):alert("请先选择文件")})}(),function(){function a(){$("#register-password input").val(""),$("#register-password-confirm input").val("")}var b=io();b.on("welcome",function(c){$("#register-apply").on("click",function(){var d=$("#register-username input").val(),e=$("#register-password input").val();USERNAME=d;var f=$("#register-password-confirm input").val();if(console.log("username:"+d+"|password:"+e+"|passwordComfirm:"+f),""===e||""===d)alert("密码和用户名不能为空，请重新输入！"),a();else if(e.length<6)alert("密码至少为6位，请重新输入！"),a();else if(e==f){var g={username:d,password:e},h=c;console.log(h);var i={ip:h,portaddr:"8888"},j={ip:"127.0.0.1",portaddr:"3000"},k="cookie null",l=packageMessage("register",i,j,k,g);console.log(l),console.log(g),b.emit("message",l)}else alert("两次输入密码不一致，请重新输入！"),a()}),b.on("response",function(b){104==b.statusCode&&(alert(b.data),a(),$("#register-username input").val("")),100==b.statusCode&&(alert("恭喜！注册成功！"),window.location="/chat?username="+$("#register-username input").val())}),$("#register-form").keydown(function(a){13===a.keyCode&&$("#register-apply").click()})})}();